require 'rant/filelist'
require 'build.rb'

gen C::Dependencies
gen Action do source "c_dependencies")

cconf = CompilerConfig.new
cconf.cc  = `which gcc`.strip
cconf.cxx = `which g++`.strip
cconf.add_cflags( "-g" )
cconf.add_cflags( "-shared" )
cconf.add_cflags( `pkg-config libxml-2.0 --cflags` )

#Add our compiler flags for libnetpbm
cconf.add_libs( "-lm" ) 
cconf.add_libs( "-lncurses" )
cconf.add_libs( `pkg-config libxml-2.0 --libs-only-l` )

#store the compiler config in var
var['cconf'] = cconf

src  = Rant::FileList[ '*.cpp' ] 
objs = src.ext( 'o' )
rt_deps = objs

desc "Build everything that has changed since the last build"
task :all => %w( sphere )

desc "Build libsphere.so"
file :sphere => objs do |task_info|
    sys "#{cconf.cxx} #{cconf.cflags} -o libsphere.so #{objs.join(' ')} #{cconf.libdirs} #{cconf.libs}"

desc "default rule for .o files"
gen Rule, :o => :cpp do |task_info|
    sys "#{cconf.cxx} #{cconf.incdirs} #{cconf.cflags} -c -o #{task_info.name} #{task_info.source}"
end
